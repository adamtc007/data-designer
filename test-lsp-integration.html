<!DOCTYPE html>
<html>
<head>
    <title>LSP Integration Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #444;
            border-radius: 5px;
            background: #2d2d30;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
        }
        .success { background: #1e3a1e; border-left: 3px solid #4caf50; }
        .fail { background: #3a1e1e; border-left: 3px solid #f44336; }
        .pending { background: #3a3a1e; border-left: 3px solid #ff9800; }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #007acc;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        button:hover { background: #005a9e; }
        #formatted-output {
            background: #1e1e1e;
            padding: 10px;
            border: 1px solid #444;
            border-radius: 3px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <h1>LSP Integration Test Suite</h1>

    <div class="test-section">
        <h2>1. WebSocket Connection Test</h2>
        <button onclick="testConnection()">Test Connection</button>
        <div id="connection-result" class="test-result pending">Waiting...</div>
    </div>

    <div class="test-section">
        <h2>2. Format Code Test</h2>
        <button onclick="testFormatting()">Test Formatting</button>
        <div id="format-result" class="test-result pending">Waiting...</div>
        <pre id="formatted-output"></pre>
    </div>

    <div class="test-section">
        <h2>3. LSP Completions Test</h2>
        <button onclick="testCompletions()">Test Completions</button>
        <div id="completion-result" class="test-result pending">Waiting...</div>
    </div>

    <div class="test-section">
        <h2>4. LSP Diagnostics Test</h2>
        <button onclick="testDiagnostics()">Test Diagnostics</button>
        <div id="diagnostic-result" class="test-result pending">Waiting...</div>
    </div>

    <script src="lsp-client.js"></script>
    <script>
        let lspClient = null;

        async function testConnection() {
            const resultDiv = document.getElementById('connection-result');
            try {
                resultDiv.className = 'test-result pending';
                resultDiv.textContent = 'Connecting to LSP server...';

                lspClient = new LSPClient('ws://localhost:3030');
                await lspClient.connect();

                resultDiv.className = 'test-result success';
                resultDiv.textContent = '✓ WebSocket connection successful! LSP initialized.';
            } catch (error) {
                resultDiv.className = 'test-result fail';
                resultDiv.textContent = `✗ Connection failed: ${error.message}`;
            }
        }

        function testFormatting() {
            const resultDiv = document.getElementById('format-result');
            const outputDiv = document.getElementById('formatted-output');

            // Test code with multiple lines and various operators
            const testCode = `IF Client.age>=18 AND Client.country_code=="US" THEN
risk_score=100+Client.credit_score*0.5
message="Welcome "&Client.first_name&" "&Client.last_name
IF risk_score>500 THEN status="approved" ELSE status="review"`;

            // Fixed formatting function from ide.html
            function formatCode(code) {
                const lines = code.split('\n');
                const formattedLines = lines.map(line => {
                    // Don't format empty lines
                    if (!line.trim()) return line;

                    // Preserve leading whitespace (indentation)
                    const leadingWhitespace = line.match(/^\s*/)[0];
                    let trimmedLine = line.trim();

                    // Add spaces around operators
                    trimmedLine = trimmedLine.replace(/([=<>!]+)/g, ' $1 ');
                    trimmedLine = trimmedLine.replace(/([+\-*/%])/g, ' $1 ');
                    trimmedLine = trimmedLine.replace(/([&|])/g, ' $1 ');

                    // Clean up multiple spaces
                    trimmedLine = trimmedLine.replace(/\s+/g, ' ').trim();

                    // Special handling for certain patterns
                    trimmedLine = trimmedLine.replace(/\s*,\s*/g, ', ');
                    trimmedLine = trimmedLine.replace(/\s*\(\s*/g, '(');
                    trimmedLine = trimmedLine.replace(/\s*\)\s*/g, ')');
                    trimmedLine = trimmedLine.replace(/\s*\.\s*/g, '.');

                    return leadingWhitespace + trimmedLine;
                });

                return formattedLines.join('\n');
            }

            try {
                const formatted = formatCode(testCode);

                // Check if line breaks are preserved
                const originalLines = testCode.split('\n').length;
                const formattedLines = formatted.split('\n').length;

                if (originalLines === formattedLines) {
                    resultDiv.className = 'test-result success';
                    resultDiv.textContent = `✓ Formatting successful! Preserved ${originalLines} lines.`;
                    outputDiv.textContent = formatted;
                } else {
                    resultDiv.className = 'test-result fail';
                    resultDiv.textContent = `✗ Formatting error: Line count mismatch (${originalLines} → ${formattedLines})`;
                    outputDiv.textContent = formatted;
                }
            } catch (error) {
                resultDiv.className = 'test-result fail';
                resultDiv.textContent = `✗ Formatting failed: ${error.message}`;
            }
        }

        async function testCompletions() {
            const resultDiv = document.getElementById('completion-result');

            if (!lspClient || !lspClient.initialized) {
                resultDiv.className = 'test-result fail';
                resultDiv.textContent = '✗ LSP not connected. Run connection test first.';
                return;
            }

            try {
                // Open a test document
                const testUri = 'file:///test.dsl';
                await lspClient.openDocument(testUri, 'dsl', 1, 'IF Client.');

                // Request completions
                const completions = await lspClient.getCompletions(testUri, 0, 10);

                if (completions && completions.length > 0) {
                    resultDiv.className = 'test-result success';
                    resultDiv.textContent = `✓ Received ${completions.length} completions: ${completions.slice(0, 3).map(c => c.label).join(', ')}...`;
                } else {
                    resultDiv.className = 'test-result fail';
                    resultDiv.textContent = '✗ No completions received';
                }
            } catch (error) {
                resultDiv.className = 'test-result fail';
                resultDiv.textContent = `✗ Completions test failed: ${error.message}`;
            }
        }

        async function testDiagnostics() {
            const resultDiv = document.getElementById('diagnostic-result');

            if (!lspClient || !lspClient.initialized) {
                resultDiv.className = 'test-result fail';
                resultDiv.textContent = '✗ LSP not connected. Run connection test first.';
                return;
            }

            try {
                let diagnosticsReceived = false;

                // Set up diagnostics callback
                lspClient.onDiagnostics((uri, diagnostics) => {
                    diagnosticsReceived = true;
                    if (diagnostics.length > 0) {
                        resultDiv.className = 'test-result success';
                        resultDiv.textContent = `✓ Received ${diagnostics.length} diagnostics: ${diagnostics[0].message}`;
                    } else {
                        resultDiv.className = 'test-result success';
                        resultDiv.textContent = '✓ No errors detected (valid code)';
                    }
                });

                // Send invalid code to trigger diagnostics
                const testUri = 'file:///test-diagnostic.dsl';
                await lspClient.openDocument(testUri, 'dsl', 1, 'IF without THEN');

                // Wait a bit for diagnostics
                await new Promise(resolve => setTimeout(resolve, 500));

                if (!diagnosticsReceived) {
                    // Try with valid code
                    await lspClient.changeDocument(testUri, 2, 'IF Client.age > 18 THEN status = "adult"');
                    await new Promise(resolve => setTimeout(resolve, 500));

                    if (!diagnosticsReceived) {
                        resultDiv.className = 'test-result fail';
                        resultDiv.textContent = '✗ No diagnostics received';
                    }
                }
            } catch (error) {
                resultDiv.className = 'test-result fail';
                resultDiv.textContent = `✗ Diagnostics test failed: ${error.message}`;
            }
        }
    </script>
</body>
</html>