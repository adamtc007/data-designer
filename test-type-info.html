<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Test Type Information Display</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #1e1e1e; color: #d4d4d4; }
        .test { margin: 20px 0; padding: 15px; border: 1px solid #444; border-radius: 5px; }
        .code { font-family: 'Courier New', monospace; background: #2d2d30; padding: 10px; border-radius: 3px; }
        .result { margin-top: 10px; padding: 10px; background: #2d2d30; border-radius: 3px; }
        .success { border-left: 3px solid #4caf50; }
        .info { border-left: 3px solid #2196f3; }
        button { padding: 10px 20px; margin: 5px; background: #007acc; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #005a9e; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>Type Information Test - LSP Data Dictionary</h1>

    <div class="test">
        <h2>Test 1: Hover Over Client.client_id</h2>
        <div class="code">IF Client.client_id == "CLT-001" THEN ...</div>
        <button onclick="testHover('Client.client_id')">Test Hover</button>
        <div id="hover-result-1" class="result"></div>
    </div>

    <div class="test">
        <h2>Test 2: Hover Over Client.aum_usd</h2>
        <div class="code">IF Client.aum_usd > 1000000 THEN ...</div>
        <button onclick="testHover('Client.aum_usd')">Test Hover</button>
        <div id="hover-result-2" class="result"></div>
    </div>

    <div class="test">
        <h2>Test 3: Completions with Type Info</h2>
        <div class="code">Type: Client.</div>
        <button onclick="testCompletions('Client.')">Test Completions</button>
        <div id="completion-result" class="result"></div>
    </div>

    <script src="lsp-client.js"></script>
    <script>
        let lspClient = null;
        let testIndex = 0;

        // Auto-connect on load
        window.addEventListener('load', async () => {
            try {
                lspClient = new LSPClient('ws://localhost:3030');
                await lspClient.connect();
                console.log('Connected to LSP');
                document.body.insertAdjacentHTML('afterbegin', '<div class="result success">✓ Connected to LSP Server</div>');
            } catch (error) {
                console.error('Failed to connect to LSP:', error);
                document.body.insertAdjacentHTML('afterbegin', '<div class="result">❌ LSP Connection Failed - Please ensure server is running on port 3030</div>');
            }
        });

        async function testHover(text) {
            testIndex++;
            const resultDiv = document.getElementById(`hover-result-${testIndex}`);

            if (!lspClient || !lspClient.initialized) {
                resultDiv.innerHTML = '<div class="info">❌ LSP not connected</div>';
                return;
            }

            try {
                // Open a test document
                const uri = `file:///test-hover-${testIndex}.dsl`;
                const content = `IF ${text} == "test" THEN status = "ok"`;
                await lspClient.openDocument(uri, 'dsl', 1, content);

                // Get hover info (position of the attribute in the line)
                const position = content.indexOf(text);
                const hover = await lspClient.sendRequest('textDocument/hover', {
                    textDocument: { uri },
                    position: { line: 0, character: position + 5 }
                });

                if (hover && hover.contents) {
                    const content = hover.contents.value || hover.contents;
                    resultDiv.innerHTML = `<div class="success">✓ Hover Information Retrieved:</div><pre>${content}</pre>`;
                } else {
                    resultDiv.innerHTML = '<div class="info">No hover information available</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="info">❌ Error: ${error.message}</div>`;
            }
        }

        async function testCompletions(prefix) {
            const resultDiv = document.getElementById('completion-result');

            if (!lspClient || !lspClient.initialized) {
                resultDiv.innerHTML = '<div class="info">❌ LSP not connected</div>';
                return;
            }

            try {
                // Open a test document
                const uri = 'file:///test-completion.dsl';
                const content = prefix;
                await lspClient.openDocument(uri, 'dsl', 1, content);

                // Get completions
                const completions = await lspClient.getCompletions(uri, 0, prefix.length);

                if (completions && completions.length > 0) {
                    let html = `<div class="success">✓ Found ${completions.length} completions:</div><ul>`;
                    for (const item of completions.slice(0, 5)) {
                        html += `<li><strong>${item.label}</strong>`;
                        if (item.detail) {
                            html += ` - <em>${item.detail}</em>`;
                        }
                        if (item.documentation) {
                            const doc = item.documentation.value || item.documentation;
                            html += `<br><small>${doc.substring(0, 200)}...</small>`;
                        }
                        html += '</li>';
                    }
                    html += '</ul>';
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = '<div class="info">No completions found</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="info">❌ Error: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>