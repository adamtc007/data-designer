<!DOCTYPE html>
<html>
<head>
    <title>Hover Debug Test</title>
    <style>
        body { font-family: Arial; padding: 20px; background: #1e1e1e; color: #d4d4d4; }
        #editor { width: 100%; height: 400px; border: 1px solid #444; }
        #debug { margin-top: 20px; padding: 10px; background: #2d2d30; border-radius: 3px; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>Monaco Hover Debug Test</h1>
    <div id="editor"></div>
    <div id="debug">
        <h3>Debug Output:</h3>
        <pre id="debug-output"></pre>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
    <script>
        const debugLog = (msg) => {
            const output = document.getElementById('debug-output');
            output.textContent += msg + '\n';
            console.log(msg);
        };

        require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' } });

        require(['vs/editor/editor.main'], function() {
            debugLog('Monaco loaded');

            // Register DSL language
            monaco.languages.register({ id: 'dsl' });
            debugLog('DSL language registered');

            // Set up hover provider
            const hoverProvider = monaco.languages.registerHoverProvider('dsl', {
                provideHover: (model, position) => {
                    debugLog(`Hover triggered at line ${position.lineNumber}, col ${position.column}`);

                    const line = model.getLineContent(position.lineNumber);
                    debugLog(`Line content: "${line}"`);

                    const word = model.getWordAtPosition(position);
                    if (word) {
                        debugLog(`Word at position: "${word.word}"`);
                    }

                    // Find the full path
                    const offset = position.column - 1;
                    let start = offset;
                    let end = offset;

                    while (start > 0 && /[\w.]/.test(line[start - 1])) {
                        start--;
                    }
                    while (end < line.length && /[\w.]/.test(line[end])) {
                        end++;
                    }

                    const fullPath = line.substring(start, end);
                    debugLog(`Full path extracted: "${fullPath}"`);

                    // Test with simple hover info
                    const hoverInfo = {
                        'Client': 'This is the Client entity',
                        'Client.client_id': 'This is client_id - VARCHAR(50)',
                        'Client.aum_usd': 'This is aum_usd - DECIMAL(18,2)',
                    };

                    if (hoverInfo[fullPath]) {
                        debugLog(`Found hover info for: "${fullPath}"`);
                        return {
                            contents: [
                                {
                                    value: `**${fullPath}**\n\n${hoverInfo[fullPath]}`
                                }
                            ]
                        };
                    }

                    debugLog('No hover info found');
                    return null;
                }
            });

            debugLog('Hover provider registered');

            // Create editor
            const editor = monaco.editor.create(document.getElementById('editor'), {
                value: `// Test DSL hover
IF Client.client_id == "CLT-001" THEN
    risk_score = Client.aum_usd * 0.01
    status = "approved"
END

// Hover over Client, Client.client_id, or Client.aum_usd`,
                language: 'dsl',
                theme: 'vs-dark',
                automaticLayout: true,
                minimap: { enabled: false }
            });

            debugLog('Editor created with DSL language');

            // Log when mouse moves
            editor.onMouseMove((e) => {
                if (e.target.position) {
                    debugLog(`Mouse at line ${e.target.position.lineNumber}, col ${e.target.position.column}`);
                }
            });
        });
    </script>
</body>
</html>