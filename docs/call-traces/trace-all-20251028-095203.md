# Call Stack Trace Analysis

**Generated:** $(date)
**Action:** $ACTION

## Purpose
This document contains code excerpts across all layers to enable Web Claude to:
1. Trace the complete call stack from UI to database
2. Identify architectural violations
3. Spot point-to-point coupling
4. Generate specific refactor instructions

## Architecture Layers
```
Layer 1: WASM/egui UI        (onboarding-wasm/src/)
Layer 2: HTTP/REST Client     (onboarding-wasm/src/onboarding/client.rs)
Layer 3: HTTP/REST Server     (grpc-server/src/http/)
Layer 4: gRPC Client Wrapper  (grpc-server/src/grpc_client/)
Layer 5: gRPC Service         (grpc-server/src/service/)
Layer 6: Database             (grpc-server/src/db/)
```

## Expected Flow (Correct Architecture)
```
UI Button Click
  → OnboardingManager.dispatch(Action)
    → OnboardingManager.handle_action()
      → HTTP POST /api/onboarding/{action}
        → HTTP handler routes to gRPC client
          → gRPC Service method
            → Database query
```

---

# Layer 1: UI - Event Handlers & Button Clicks


# Layer 2: State Manager


# Layer 3: Backend Client (WASM → Backend)


# Layer 4: gRPC Server


# Layer 5: Database Layer


# Protocol Buffers Definition


---

# Analysis Request for Web Claude

## Tasks

### 1. Trace Complete Call Stacks
For each major UI action (StartOnboarding, SubmitKyc, AdvanceStep, etc.):
- Map the complete call path from UI button → Database
- List each function/method called
- Identify which layer each call is in
- Show the data flow

### 2. Identify Architectural Violations
Look for:
- ❌ UI calling backend directly (skipping OnboardingManager)
- ❌ UI calling gRPC directly (skipping HTTP layer)
- ❌ State mutations outside OnboardingManager
- ❌ Business logic in UI components
- ❌ Point-to-point coupling

### 3. Verify Correct Patterns
Check for:
- ✅ UI only dispatches actions to OnboardingManager
- ✅ OnboardingManager owns all state
- ✅ Manager makes HTTP calls (not gRPC directly from WASM)
- ✅ Clean layer boundaries
- ✅ No backend logic in UI

### 4. Generate Refactoring Instructions
For each violation found:
1. Show the current code (quote the specific lines)
2. Explain why it's wrong (which layer boundary it violates)
3. Provide the corrected code
4. Show where it should go

### 5. Create Call Stack Diagrams
Generate markdown diagrams showing:
- Current (actual) call flow
- Expected (correct) call flow
- Highlight differences

## Output Format

Please structure your response as:

```markdown
# Call Stack Analysis Report

## Executive Summary
[High-level findings]

## Detailed Call Stacks
[For each action, map the flow]

## Violations Found
[List each violation with code quotes]

## Refactoring Required
[Specific changes needed]

## Updated REFACTOR_PLAN.md
[Generate updated plan if needed]
```


